{"ast":null,"code":"var _jsxFileName = \"/home/phillz/Documents/philiptran-sandbox/app_controller/src/components/bluetoothHandler.tsx\";\n// Handles connecting to bluetooth and sending files over BLE\n// Renders a button to prompt user to connect to bluetooth device\n// and an input field to upload a .bin file \nimport React from 'react';\n\nclass FileHandler {\n  // handles file loading and file sending over BLE\n  constructor(fileRef, characteristic) {\n    this.idx = void 0;\n    this.chunks = void 0;\n    this.fileRef = void 0;\n    this.characteristic = void 0;\n    this.idx = 0;\n    this.chunks = [];\n    this.fileRef = fileRef;\n    this.characteristic = characteristic;\n  }\n\n  set(chunks) {\n    this.idx = 0;\n    this.chunks = chunks;\n  }\n\n  nextChunk() {\n    return this.chunks[this.idx++];\n  }\n\n  getIdx() {\n    return this.idx;\n  }\n\n  hasNext() {\n    return this.idx < this.chunks.length;\n  }\n\n  loadFile() {\n    // load the file stored in the 'input' element of BluetoothHandler\n    let input = this.fileRef.current;\n    let file = input.files[0];\n    let fr = new FileReader();\n\n    const processLoadedText = async () => {\n      let result = fr.result;\n\n      if (result) {\n        this.chunks = split(result);\n\n        for (var i = 0; i < this.chunks.length; i++) {\n          await this.characteristic.writeValue(this.chunks[i]);\n        }\n\n        let enc = new TextEncoder();\n        await this.characteristic.writeValue(enc.encode(\"done\"));\n      }\n    };\n\n    fr.onload = processLoadedText.bind(this);\n    fr.readAsArrayBuffer(file);\n  }\n\n}\n\nclass BluetoothHandler extends React.Component {\n  constructor(props) {\n    super(props);\n    this.characteristic = void 0;\n    this.fileHandler = void 0;\n    this.fileRef = void 0;\n    this.characteristic = null;\n    this.fileRef = React.createRef();\n    this.fileHandler = new FileHandler(this.fileRef, this.characteristic);\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"flex-container\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 82,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      id: \"item\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 83,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"button\", {\n      id: \"button\",\n      onClick: this.connectToDevice.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 84,\n        columnNumber: 21\n      }\n    }, \" Connnect \")), /*#__PURE__*/React.createElement(\"div\", {\n      id: \"item\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 86,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"input\", {\n      id: \"button\",\n      type: \"file\",\n      ref: this.fileRef,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 87,\n        columnNumber: 21\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      id: \"item\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 89,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"button\", {\n      id: \"button\",\n      onClick: this.fileHandler.loadFile.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 90,\n        columnNumber: 21\n      }\n    }, \" Upload \"))));\n  }\n\n  connectToDevice() {\n    let navigator = window.navigator;\n    var UUID = \"8601cf7e-8291-4cb7-baef-cf570c53485f\";\n    navigator.bluetooth.requestDevice({\n      acceptAllDevices: true,\n      optionalServices: [UUID]\n    }).then(device => {\n      console.log('Connecting to GATT Server...');\n      return device.gatt.connect();\n    }).then(server => {\n      console.log(\"getting service\");\n      return server.getPrimaryService(UUID);\n    }).then(service => {\n      console.log(\"Getting characteristics\");\n      return service.getCharacteristic('f2aec022-00ac-44b4-8158-07c48d2024c1');\n    }).then(_characteristic => {\n      console.log(\"getting characteristic\");\n      this.characteristic = _characteristic;\n      console.log(this.characteristic);\n    });\n  }\n\n  sendFile() {}\n\n}\n\nfunction split(result) {\n  let chunkSize = 500; // save 1 byte for our delimiter (max bytes is 512)\n\n  let splitList = [];\n  let enc = new TextEncoder(); // used to encode our delimiters \n\n  while (result.byteLength > 0) {\n    var chunk = result.slice(0, chunkSize);\n    splitList.push(appendBuffer(chunk, enc.encode('|')));\n    result = result.slice(chunkSize);\n  } // send over the bytelength of the final chunk to send to C side so it knows when \n  // all the chunks have been sent.\n\n\n  splitList.unshift(enc.encode(\"\" + splitList[splitList.length - 1].byteLength));\n  return splitList;\n}\n\nfunction appendBuffer(buffer1, buffer2) {\n  var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n  tmp.set(new Uint8Array(buffer1), 0);\n  tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n  return tmp.buffer;\n}\n\n;\nexport default BluetoothHandler;","map":{"version":3,"sources":["/home/phillz/Documents/philiptran-sandbox/app_controller/src/components/bluetoothHandler.tsx"],"names":["React","FileHandler","constructor","fileRef","characteristic","idx","chunks","set","nextChunk","getIdx","hasNext","length","loadFile","input","current","file","files","fr","FileReader","processLoadedText","result","split","i","writeValue","enc","TextEncoder","encode","onload","bind","readAsArrayBuffer","BluetoothHandler","Component","props","fileHandler","createRef","render","connectToDevice","navigator","window","UUID","bluetooth","requestDevice","acceptAllDevices","optionalServices","then","device","console","log","gatt","connect","server","getPrimaryService","service","getCharacteristic","_characteristic","sendFile","chunkSize","splitList","byteLength","chunk","slice","push","appendBuffer","unshift","buffer1","buffer2","tmp","Uint8Array","buffer"],"mappings":";AAAA;AACA;AACA;AAEA,OAAOA,KAAP,MAAkB,OAAlB;;AAEA,MAAMC,WAAN,CAAkB;AACd;AAOAC,EAAAA,WAAW,CAACC,OAAD,EAAeC,cAAf,EAAoC;AAAA,SALvCC,GAKuC;AAAA,SAJvCC,MAIuC;AAAA,SAHvCH,OAGuC;AAAA,SAFvCC,cAEuC;AAC3C,SAAKC,GAAL,GAAW,CAAX;AACA,SAAKC,MAAL,GAAc,EAAd;AACA,SAAKH,OAAL,GAAeA,OAAf;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACH;;AAEDG,EAAAA,GAAG,CAACD,MAAD,EAA4B;AAC3B,SAAKD,GAAL,GAAW,CAAX;AACA,SAAKC,MAAL,GAAcA,MAAd;AACH;;AAEDE,EAAAA,SAAS,GAAG;AACR,WAAO,KAAKF,MAAL,CAAY,KAAKD,GAAL,EAAZ,CAAP;AACH;;AAEDI,EAAAA,MAAM,GAAG;AACL,WAAO,KAAKJ,GAAZ;AACH;;AAEDK,EAAAA,OAAO,GAAG;AACN,WAAO,KAAKL,GAAL,GAAW,KAAKC,MAAL,CAAYK,MAA9B;AACH;;AAEDC,EAAAA,QAAQ,GAAG;AACP;AACA,QAAIC,KAAK,GAAG,KAAKV,OAAL,CAAaW,OAAzB;AACA,QAAIC,IAAI,GAAGF,KAAK,CAACG,KAAN,CAAY,CAAZ,CAAX;AACA,QAAIC,EAAE,GAAG,IAAIC,UAAJ,EAAT;;AAEA,UAAMC,iBAAiB,GAAG,YAAY;AAClC,UAAIC,MAAM,GAAGH,EAAE,CAACG,MAAhB;;AAEA,UAAGA,MAAH,EACA;AACI,aAAKd,MAAL,GAAce,KAAK,CAACD,MAAD,CAAnB;;AAEA,aAAI,IAAIE,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAG,KAAKhB,MAAL,CAAYK,MAA/B,EAAuCW,CAAC,EAAxC,EAA4C;AACxC,gBAAM,KAAKlB,cAAL,CAAoBmB,UAApB,CAA+B,KAAKjB,MAAL,CAAYgB,CAAZ,CAA/B,CAAN;AACH;;AACD,YAAIE,GAAG,GAAG,IAAIC,WAAJ,EAAV;AACA,cAAM,KAAKrB,cAAL,CAAoBmB,UAApB,CAA+BC,GAAG,CAACE,MAAJ,CAAW,MAAX,CAA/B,CAAN;AACH;AACJ,KAbD;;AAeAT,IAAAA,EAAE,CAACU,MAAH,GAAYR,iBAAiB,CAACS,IAAlB,CAAuB,IAAvB,CAAZ;AACAX,IAAAA,EAAE,CAACY,iBAAH,CAAqBd,IAArB;AACH;;AAvDa;;AA2DlB,MAAMe,gBAAN,SAA+B9B,KAAK,CAAC+B,SAArC,CAA+C;AAM3C7B,EAAAA,WAAW,CAAC8B,KAAD,EAAa;AACpB,UAAMA,KAAN;AADoB,SAJhB5B,cAIgB;AAAA,SAHhB6B,WAGgB;AAAA,SAFhB9B,OAEgB;AAEpB,SAAKC,cAAL,GAAsB,IAAtB;AACA,SAAKD,OAAL,GAAeH,KAAK,CAACkC,SAAN,EAAf;AACA,SAAKD,WAAL,GAAmB,IAAIhC,WAAJ,CAAgB,KAAKE,OAArB,EAA8B,KAAKC,cAAnC,CAAnB;AACH;;AAED+B,EAAAA,MAAM,GAAG;AACL,wBACI,uDACA;AAAK,MAAA,SAAS,EAAC,gBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACI;AAAK,MAAA,EAAE,EAAE,MAAT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACI;AAAQ,MAAA,EAAE,EAAC,QAAX;AAAoB,MAAA,OAAO,EAAI,KAAKC,eAAL,CAAqBR,IAArB,CAA0B,IAA1B,CAA/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBADJ,CADJ,eAII;AAAK,MAAA,EAAE,EAAG,MAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACI;AAAO,MAAA,EAAE,EAAC,QAAV;AAAmB,MAAA,IAAI,EAAC,MAAxB;AAA+B,MAAA,GAAG,EAAE,KAAKzB,OAAzC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ,CAJJ,eAOI;AAAK,MAAA,EAAE,EAAG,MAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACI;AAAQ,MAAA,EAAE,EAAC,QAAX;AAAoB,MAAA,OAAO,EAAE,KAAK8B,WAAL,CAAiBrB,QAAjB,CAA0BgB,IAA1B,CAA+B,IAA/B,CAA7B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBADJ,CAPJ,CADA,CADJ;AAeH;;AAEDQ,EAAAA,eAAe,GAAG;AACd,QAAIC,SAAc,GAAGC,MAAM,CAACD,SAA5B;AACA,QAAIE,IAAI,GAAG,sCAAX;AACAF,IAAAA,SAAS,CAACG,SAAV,CAAoBC,aAApB,CAAkC;AAACC,MAAAA,gBAAgB,EAAC,IAAlB;AAAuBC,MAAAA,gBAAgB,EAAE,CAACJ,IAAD;AAAzC,KAAlC,EACCK,IADD,CACOC,MAAD,IAAgD;AAClDC,MAAAA,OAAO,CAACC,GAAR,CAAY,8BAAZ;AACA,aAAOF,MAAM,CAACG,IAAP,CAAYC,OAAZ,EAAP;AACH,KAJD,EAKCL,IALD,CAKOM,MAAD,IAA2D;AAC7DJ,MAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;AACA,aAAOG,MAAM,CAACC,iBAAP,CAAyBZ,IAAzB,CAAP;AACH,KARD,EASCK,IATD,CASOQ,OAAD,IAA4D;AAC9DN,MAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ;AACA,aAAOK,OAAO,CAACC,iBAAR,CAA0B,sCAA1B,CAAP;AACH,KAZD,EAaCT,IAbD,CAaOU,eAAD,IAA0B;AAC5BR,MAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ;AACA,WAAK3C,cAAL,GAAsBkD,eAAtB;AACAR,MAAAA,OAAO,CAACC,GAAR,CAAY,KAAK3C,cAAjB;AAEH,KAlBD;AAmBH;;AAEDmD,EAAAA,QAAQ,GAAE,CAET;;AAzD0C;;AA8D/C,SAASlC,KAAT,CAAeD,MAAf,EAAkC;AAE9B,MAAIoC,SAAS,GAAG,GAAhB,CAF8B,CAET;;AACrB,MAAIC,SAAS,GAAG,EAAhB;AACA,MAAIjC,GAAG,GAAG,IAAIC,WAAJ,EAAV,CAJ8B,CAID;;AAE7B,SAAML,MAAM,CAACsC,UAAP,GAAoB,CAA1B,EAA6B;AACzB,QAAIC,KAAK,GAAGvC,MAAM,CAACwC,KAAP,CAAa,CAAb,EAAgBJ,SAAhB,CAAZ;AACAC,IAAAA,SAAS,CAACI,IAAV,CAAeC,YAAY,CAACH,KAAD,EAAQnC,GAAG,CAACE,MAAJ,CAAW,GAAX,CAAR,CAA3B;AACAN,IAAAA,MAAM,GAAGA,MAAM,CAACwC,KAAP,CAAaJ,SAAb,CAAT;AACH,GAV6B,CAY9B;AACA;;;AACAC,EAAAA,SAAS,CAACM,OAAV,CAAkBvC,GAAG,CAACE,MAAJ,CAAW,KAAG+B,SAAS,CAACA,SAAS,CAAC9C,MAAV,GAAmB,CAApB,CAAT,CAAgC+C,UAA9C,CAAlB;AACA,SAAOD,SAAP;AACH;;AAED,SAAUK,YAAV,CAAuBE,OAAvB,EAA6CC,OAA7C,EAAmE;AAC/D,MAAIC,GAAG,GAAG,IAAIC,UAAJ,CAAeH,OAAO,CAACN,UAAR,GAAqBO,OAAO,CAACP,UAA5C,CAAV;AACAQ,EAAAA,GAAG,CAAC3D,GAAJ,CAAQ,IAAI4D,UAAJ,CAAeH,OAAf,CAAR,EAAiC,CAAjC;AACAE,EAAAA,GAAG,CAAC3D,GAAJ,CAAQ,IAAI4D,UAAJ,CAAeF,OAAf,CAAR,EAAiCD,OAAO,CAACN,UAAzC;AACA,SAAOQ,GAAG,CAACE,MAAX;AACH;;AAAA;AAED,eAAetC,gBAAf","sourcesContent":["// Handles connecting to bluetooth and sending files over BLE\n// Renders a button to prompt user to connect to bluetooth device\n// and an input field to upload a .bin file \n\nimport React from 'react';\n\nclass FileHandler {\n    // handles file loading and file sending over BLE\n\n    private idx:number;\n    private chunks:Array<ArrayBuffer>;\n    private fileRef: any;\n    private characteristic: any;\n\n    constructor(fileRef: any, characteristic: any) {\n        this.idx = 0;\n        this.chunks = [];\n        this.fileRef = fileRef;\n        this.characteristic = characteristic;\n    }\n\n    set(chunks:Array<ArrayBuffer>) {\n        this.idx = 0;\n        this.chunks = chunks;\n    }\n\n    nextChunk() {\n        return(this.chunks[this.idx++]);\n    }\n\n    getIdx() {\n        return(this.idx);\n    }\n\n    hasNext() {\n        return(this.idx < this.chunks.length);\n    }\n\n    loadFile() {\n        // load the file stored in the 'input' element of BluetoothHandler\n        let input = this.fileRef.current;\n        let file = input.files[0];\n        let fr = new FileReader(); \n\n        const processLoadedText = async () => {\n            let result = fr.result as ArrayBuffer; \n\n            if(result)\n            {\n                this.chunks = split(result);\n                \n                for(var i = 0; i < this.chunks.length; i++) {\n                    await this.characteristic.writeValue(this.chunks[i]);\n                }\n                let enc = new TextEncoder();\n                await this.characteristic.writeValue(enc.encode(\"done\"))\n            }\n        }\n\n        fr.onload = processLoadedText.bind(this); \n        fr.readAsArrayBuffer(file); \n    }\n\n}\n\nclass BluetoothHandler extends React.Component {\n\n    private characteristic: any;\n    private fileHandler: FileHandler;\n    private fileRef: any;\n\n    constructor(props: any) {\n        super(props); \n        this.characteristic = null;\n        this.fileRef = React.createRef();\n        this.fileHandler = new FileHandler(this.fileRef, this.characteristic);\n    }\n\n    render() {\n        return ( \n            <>\n            <div className=\"flex-container\">\n                <div id =\"item\">\n                    <button id=\"button\" onClick = {this.connectToDevice.bind(this)}> Connnect </button> \n                </div>\n                <div id = \"item\">\n                    <input id=\"button\" type=\"file\" ref={this.fileRef}></input>\n                </div>\n                <div id = \"item\">\n                    <button id=\"button\" onClick={this.fileHandler.loadFile.bind(this)}> Upload </button>\n                </div>\n            </div>\n            </>\n        );\n    }\n\n    connectToDevice() {\n        let navigator: any = window.navigator\n        var UUID = \"8601cf7e-8291-4cb7-baef-cf570c53485f\";\n        navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices: [UUID]})\n        .then((device: { gatt: { connect: () => any; }; }) => {\n            console.log('Connecting to GATT Server...');\n            return device.gatt.connect();\n        })\n        .then((server: { getPrimaryService: (arg0: string) => any; }) => {\n            console.log(\"getting service\");\n            return(server.getPrimaryService(UUID));\n        })\n        .then((service: { getCharacteristic: (arg0: string) => any; }) => {\n            console.log(\"Getting characteristics\");\n            return service.getCharacteristic('f2aec022-00ac-44b4-8158-07c48d2024c1');\n        })\n        .then((_characteristic: any) => {\n            console.log(\"getting characteristic\");\n            this.characteristic = _characteristic;\n            console.log(this.characteristic);\n\n        })\n    }\n\n    sendFile(){\n\n    }\n\n\n}\n\nfunction split(result:ArrayBuffer){\n\n    let chunkSize = 500; // save 1 byte for our delimiter (max bytes is 512)\n    let splitList = []; \n    let enc = new TextEncoder(); // used to encode our delimiters \n\n    while(result.byteLength > 0) {\n        var chunk = result.slice(0, chunkSize);\n        splitList.push(appendBuffer(chunk, enc.encode('|')));\n        result = result.slice(chunkSize);\n    }\n\n    // send over the bytelength of the final chunk to send to C side so it knows when \n    // all the chunks have been sent.\n    splitList.unshift(enc.encode(\"\"+splitList[splitList.length - 1].byteLength));\n    return splitList;\n}\n\nfunction  appendBuffer(buffer1: ArrayBuffer, buffer2: ArrayBuffer) {\n    var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n    tmp.set(new Uint8Array(buffer1), 0);\n    tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n    return tmp.buffer;\n};\n\nexport default BluetoothHandler;"]},"metadata":{},"sourceType":"module"}