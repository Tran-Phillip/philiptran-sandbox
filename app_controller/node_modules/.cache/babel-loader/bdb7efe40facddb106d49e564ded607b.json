{"ast":null,"code":"var _jsxFileName = \"/home/phillz/Documents/philiptran-sandbox/app_controller/src/components/bluetoothHandler.tsx\";\n// Handles connecting to bluetooth and sending files over BLE\n// Renders a button to prompt user to connect to bluetooth device\n// and an input field to upload a .bin file \nimport React from 'react';\n\nclass FileHandler {\n  // handles file loading and file sending over BLE\n  constructor(fileRef, characteristic) {\n    this.idx = void 0;\n    this.chunks = void 0;\n    this.fileRef = void 0;\n    this.characteristic = void 0;\n    this.idx = 0;\n    this.chunks = [];\n    this.fileRef = fileRef;\n    this.characteristic = characteristic;\n  }\n\n  set(chunks) {\n    this.idx = 0;\n    this.chunks = chunks;\n  }\n\n  nextChunk() {\n    return this.chunks[this.idx++];\n  }\n\n  getIdx() {\n    return this.idx;\n  }\n\n  hasNext() {\n    return this.idx < this.chunks.length;\n  }\n\n  loadFile() {\n    // load the file stored in the 'input' element of BluetoothHandler\n    let input = this.fileRef.current;\n    let file = input.files[0];\n    let fr = new FileReader();\n\n    const processLoadedText = async () => {\n      let result = fr.result;\n\n      if (result) {\n        this.chunks = split(result);\n\n        for (var i = 0; i < this.chunks.length; i++) {\n          await this.characteristic.writeValue(this.chunks[i]);\n        }\n\n        console.log(this.chunks);\n      }\n    };\n\n    fr.onload = processLoadedText.bind(this);\n    fr.readAsArrayBuffer(file);\n  }\n\n}\n\nclass BluetoothHandler extends React.Component {\n  constructor(props) {\n    super(props);\n    this.characteristic = void 0;\n    this.fileHandler = void 0;\n    this.fileRef = void 0;\n    this.characteristic = null;\n    this.fileRef = React.createRef();\n    this.fileHandler = new FileHandler(this.fileRef, this.characteristic);\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"button\", {\n      onClick: this.connectToDevice.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 83,\n        columnNumber: 13\n      }\n    }, \" Connnect \"), /*#__PURE__*/React.createElement(\"input\", {\n      type: \"file\",\n      ref: this.fileRef,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 84,\n        columnNumber: 13\n      }\n    }), /*#__PURE__*/React.createElement(\"button\", {\n      onClick: this.fileHandler.loadFile.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 85,\n        columnNumber: 13\n      }\n    }, \" Upload \"));\n  }\n\n  connectToDevice() {\n    let navigator = window.navigator;\n    var UUID = \"8601cf7e-8291-4cb7-baef-cf570c53485f\";\n    navigator.bluetooth.requestDevice({\n      acceptAllDevices: true,\n      optionalServices: [UUID]\n    }).then(device => {\n      console.log('Connecting to GATT Server...');\n      return device.gatt.connect();\n    }).then(server => {\n      console.log(\"getting service\");\n      return server.getPrimaryService(UUID);\n    }).then(service => {\n      console.log(\"Getting characteristics\");\n      return service.getCharacteristic('f2aec022-00ac-44b4-8158-07c48d2024c1');\n    }).then(_characteristic => {\n      console.log(\"getting characteristic\");\n      this.characteristic = _characteristic;\n      console.log(this.characteristic);\n    });\n  }\n\n  sendFile() {}\n\n}\n\nfunction split(result) {\n  let chunkSize = 511; // save 1 byte for our delimiter (max bytes is 512)\n\n  let splitList = [];\n  let enc = new TextEncoder(); // used to encode our delimiters \n\n  while (result.byteLength > 0) {\n    var chunk = result.slice(0, chunkSize);\n    splitList.push(appendBuffer(chunk, enc.encode('|')));\n    result = result.slice(511);\n  } // send over the bytelength of the final chunk to send to C side so it knows when \n  // all the chunks have been sent.\n\n\n  splitList.unshift(enc.encode(\"\" + splitList[splitList.length - 1].byteLength));\n  return splitList;\n}\n\nfunction appendBuffer(buffer1, buffer2) {\n  var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n  tmp.set(new Uint8Array(buffer1), 0);\n  tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n  return tmp.buffer;\n}\n\n;\nexport default BluetoothHandler;","map":{"version":3,"sources":["/home/phillz/Documents/philiptran-sandbox/app_controller/src/components/bluetoothHandler.tsx"],"names":["React","FileHandler","constructor","fileRef","characteristic","idx","chunks","set","nextChunk","getIdx","hasNext","length","loadFile","input","current","file","files","fr","FileReader","processLoadedText","result","split","i","writeValue","console","log","onload","bind","readAsArrayBuffer","BluetoothHandler","Component","props","fileHandler","createRef","render","connectToDevice","navigator","window","UUID","bluetooth","requestDevice","acceptAllDevices","optionalServices","then","device","gatt","connect","server","getPrimaryService","service","getCharacteristic","_characteristic","sendFile","chunkSize","splitList","enc","TextEncoder","byteLength","chunk","slice","push","appendBuffer","encode","unshift","buffer1","buffer2","tmp","Uint8Array","buffer"],"mappings":"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","sourcesContent":["// Handles connecting to bluetooth and sending files over BLE\n// Renders a button to prompt user to connect to bluetooth device\n// and an input field to upload a .bin file \n\nimport React from 'react';\n\nclass FileHandler {\n    // handles file loading and file sending over BLE\n\n    private idx:number;\n    private chunks:Array<ArrayBuffer>;\n    private fileRef: any;\n    private characteristic: any;\n\n    constructor(fileRef: any, characteristic: any) {\n        this.idx = 0;\n        this.chunks = [];\n        this.fileRef = fileRef;\n        this.characteristic = characteristic;\n    }\n\n    set(chunks:Array<ArrayBuffer>) {\n        this.idx = 0;\n        this.chunks = chunks;\n    }\n\n    nextChunk() {\n        return(this.chunks[this.idx++]);\n    }\n\n    getIdx() {\n        return(this.idx);\n    }\n\n    hasNext() {\n        return(this.idx < this.chunks.length);\n    }\n\n    loadFile() {\n        // load the file stored in the 'input' element of BluetoothHandler\n        let input = this.fileRef.current;\n        let file = input.files[0];\n        let fr = new FileReader(); \n\n        const processLoadedText = async () => {\n            let result = fr.result as ArrayBuffer; \n\n            if(result)\n            {\n                this.chunks = split(result);\n                \n                for(var i = 0; i < this.chunks.length; i++) {\n                    await this.characteristic.writeValue(this.chunks[i]);\n                }\n            \n                console.log(this.chunks);\n            }\n\n        }\n\n        fr.onload = processLoadedText.bind(this); \n        fr.readAsArrayBuffer(file); \n    }\n\n}\n\nclass BluetoothHandler extends React.Component {\n\n    private characteristic: any;\n    private fileHandler: FileHandler;\n    private fileRef: any;\n\n    constructor(props: any) {\n        super(props); \n        this.characteristic = null;\n        this.fileRef = React.createRef();\n        this.fileHandler = new FileHandler(this.fileRef, this.characteristic);\n    }\n\n    render() {\n        return ( \n            <>\n            <button onClick = {this.connectToDevice.bind(this)}> Connnect </button> \n            <input type=\"file\" ref={this.fileRef}></input>\n            <button onClick={this.fileHandler.loadFile.bind(this)}> Upload </button>\n            </>\n        );\n    }\n\n    connectToDevice() {\n        let navigator: any = window.navigator\n        var UUID = \"8601cf7e-8291-4cb7-baef-cf570c53485f\";\n        navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices: [UUID]})\n        .then((device: { gatt: { connect: () => any; }; }) => {\n            console.log('Connecting to GATT Server...');\n            return device.gatt.connect();\n        })\n        .then((server: { getPrimaryService: (arg0: string) => any; }) => {\n            console.log(\"getting service\");\n            return(server.getPrimaryService(UUID));\n        })\n        .then((service: { getCharacteristic: (arg0: string) => any; }) => {\n            console.log(\"Getting characteristics\");\n            return service.getCharacteristic('f2aec022-00ac-44b4-8158-07c48d2024c1');\n        })\n        .then((_characteristic: any) => {\n            console.log(\"getting characteristic\");\n            this.characteristic = _characteristic;\n            console.log(this.characteristic);\n\n        })\n    }\n\n    sendFile(){\n\n    }\n\n\n}\n\nfunction split(result:ArrayBuffer){\n\n    let chunkSize = 511; // save 1 byte for our delimiter (max bytes is 512)\n    let splitList = []; \n    let enc = new TextEncoder(); // used to encode our delimiters \n\n    while(result.byteLength > 0) {\n        var chunk = result.slice(0, chunkSize);\n        splitList.push(appendBuffer(chunk, enc.encode('|')));\n        result = result.slice(511);\n    }\n\n    // send over the bytelength of the final chunk to send to C side so it knows when \n    // all the chunks have been sent.\n    splitList.unshift(enc.encode(\"\"+splitList[splitList.length - 1].byteLength));\n    return splitList;\n}\n\nfunction  appendBuffer(buffer1: ArrayBuffer, buffer2: ArrayBuffer) {\n    var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n    tmp.set(new Uint8Array(buffer1), 0);\n    tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n    return tmp.buffer;\n};\n\nexport default BluetoothHandler;"]},"metadata":{},"sourceType":"module"}